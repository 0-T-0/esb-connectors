<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ /*
  ~ * Copyright (c) 2015, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
  ~ *
  ~ * WSO2 Inc. licenses this file to you under the Apache License,
  ~ * Version 2.0 (the "License"); you may not use this file except
  ~ * in compliance with the License.
  ~ * You may obtain a copy of the License at
  ~ *
  ~ *    http://www.apache.org/licenses/LICENSE-2.0
  ~ *
  ~ * Unless required by applicable law or agreed to in writing,
  ~ * software distributed under the License is distributed on an
  ~ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ * KIND, either express or implied.  See the License for the
  ~ * specific language governing permissions and limitations
  ~ * under the License.
  ~ */
  -->

<template xmlns="http://ws.apache.org/ns/synapse" name="importEvent">
    <parameter name="identity" description="Visitor's identity information."/>
    <parameter name="identitySource" description="Type of visitor's identity information."/>
    <parameter name="eventName" description="Name of the event."/>
    <parameter name="eventSource" description="Source of the event."/>

    <parameter name="eventDate" description="Event date and time (UTC:YYYY-MM-DD HH:mm:ss.sss)."/>
    <parameter name="touchId" description="Internal identifier for the touch."/>
    <parameter name="url" description="Event's URL."/>
    <parameter name="referralUrl" description="Referrer's URL."/>
    <parameter name="title" description="Page title."/>
    <parameter name="userAgent" description="Visitor's user agent."/>
    <parameter name="platform" description="Visitor's platform."/>
    <parameter name="ipAddress" description="Visitor's IP address."/>
    <parameter name="identities" description="Identity information."/>
    <parameter name="personUdf" description="User-defined field for a person."/>
    <parameter name="touchUdf" description="User-defined field for a touch."/>
    <parameter name="eventUdf" description="User-defined field for an event."/>
    <sequence>
        <property name="acquia.contextdb.identity" expression="$func:identity"/>
        <property name="acquia.contextdb.identitySource" expression="$func:identitySource"/>
        <property name="acquia.contextdb.eventName" expression="$func:eventName"/>
        <property name="acquia.contextdb.eventSource" expression="$func:eventSource"/>
        <property name="acquia.contextdb.parameters"
                  expression="fn:concat('identity=',get-property('acquia.contextdb.identity'),'&amp;identity_source=',get-property('acquia.contextdb.identitySource'),'&amp;event_name=',get-property('acquia.contextdb.eventName'),'&amp;event_source=',get-property('acquia.contextdb.eventSource'))"/>

        <property name="acquia.contextdb.eventDate" expression="$func:eventDate"/>
        <property name="acquia.contextdb.touchId" expression="$func:touchId"/>
        <property name="acquia.contextdb.url" expression="$func:url"/>
        <property name="acquia.contextdb.referralUrl" expression="$func:referralUrl"/>
        <property name="acquia.contextdb.title" expression="$func:title"/>
        <property name="acquia.contextdb.userAgent" expression="$func:userAgent"/>
        <property name="acquia.contextdb.platform" expression="$func:platform"/>
        <property name="acquia.contextdb.ipAddress" expression="$func:ipAddress"/>
        <property name="acquia.contextdb.identities" expression="$func:identities"/>
        <property name="acquia.contextdb.personUdf" expression="$func:personUdf"/>
        <property name="acquia.contextdb.touchUdf" expression="$func:touchUdf"/>
        <property name="acquia.contextdb.eventUdf" expression="$func:eventUdf"/>
        <filter
                xpath="(not(get-property('acquia.contextdb.eventDate') = '' or  (not(string(get-property('acquia.contextdb.eventDate'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;event_date=',get-property('acquia.contextdb.eventDate'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.touchId') = '' or  (not(string(get-property('acquia.contextdb.touchId'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;touch_id=',get-property('acquia.contextdb.touchId'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.url') = '' or  (not(string(get-property('acquia.contextdb.url'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;url=',get-property('acquia.contextdb.url'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.referralUrl') = '' or  (not(string(get-property('acquia.contextdb.referralUrl'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;referral_url=',get-property('acquia.contextdb.referralUrl'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.title') = '' or  (not(string(get-property('acquia.contextdb.title'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;title=',get-property('acquia.contextdb.title'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.userAgent') = '' or  (not(string(get-property('acquia.contextdb.userAgent'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;user_agent=',get-property('acquia.contextdb.userAgent'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.platform') = '' or  (not(string(get-property('acquia.contextdb.platform'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;platform=',get-property('acquia.contextdb.platform'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.ipAddress') = '' or  (not(string(get-property('acquia.contextdb.ipAddress'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;ip_address=',get-property('acquia.contextdb.ipAddress'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.identities') = '' or  (not(string(get-property('acquia.contextdb.identities'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;identities=',get-property('acquia.contextdb.identities'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.personUdf') = '' or  (not(string(get-property('acquia.contextdb.personUdf'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;person_udf=',get-property('acquia.contextdb.personUdf'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.touchUdf') = '' or  (not(string(get-property('acquia.contextdb.touchUdf'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;touch_udf=',get-property('acquia.contextdb.touchUdf'))"/>
            </then>
        </filter>
        <filter
                xpath="(not(get-property('acquia.contextdb.eventUdf') = '' or  (not(string(get-property('acquia.contextdb.eventUdf'))))))">
            <then>
                <property name="acquia.contextdb.parameters"
                          expression="fn:concat(get-property('acquia.contextdb.parameters'),'&amp;event_udf=',get-property('acquia.contextdb.eventUdf'))"/>
            </then>
        </filter>
        <property name="acquia.contextdb.accountId" expression="$func:accountId"/>
        <property name="acquia.contextdb.apiUri.final"
                  expression="fn:concat(get-property('acquia.contextdb.apiUri'),get-property('acquia.contextdb.accountId'),'/event_import')"/>
        <property name="acquia.contextdb.httpMethod" value="POST"/>
        <property name="uri.var.apiUri.final" expression="get-property('acquia.contextdb.apiUri.final')"/>

        <class name="org.wso2.carbon.connector.authentication.AcquiaContextDbGenerateSignature"/>
        <property name="uri.var.signature" expression="get-property('acquia.contextdb.signature')"/>
        <header name="Authorization" expression="get-property('uri.var.signature')"
                scope="transport"/>
        <call>
            <endpoint>
                <http method="POST"
                      uri-template="{uri.var.apiUri.final}?{acquia.contextdb.parameters}"/>
            </endpoint>
        </call>
    </sequence>
</template>